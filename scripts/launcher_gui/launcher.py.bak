import sys
import webbrowser
from PySide6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QLabel, QListWidget, QListWidgetItem,
    QTextEdit, QSplitter, QMessageBox
)
from PySide6.QtCore import Qt, QProcess, QTimer
import os
from typing import Dict

from .services import build_services, ServiceDef
from .logging_utils import append_log
from .config import service_env, read_env_ports


class ServiceProcess:
    def __init__(self, defn: ServiceDef):
        self.defn = defn
        self.proc: QProcess | None = None
        self.running = False

    def start(self):
        if self.running:
            return
        self.proc = QProcess()
        env = service_env()
        if self.defn.env_overrides:
            env.update(self.defn.env_overrides)
        qenv = self.proc.processEnvironment()
        for k, v in env.items():
            qenv.insert(k, v)
        self.proc.setProcessEnvironment(qenv)
        self.proc.setProgram(self.defn.program)
        self.proc.setArguments(self.defn.args)
        self.proc.setWorkingDirectory(self.defn.cwd)
        self.proc.readyReadStandardOutput.connect(lambda: self._capture(False))
        self.proc.readyReadStandardError.connect(lambda: self._capture(True))
        self.proc.finished.connect(self._finished)
        append_log('launcher.log', f"START {self.defn.key} {' '.join(self.defn.args)}")
        self.proc.start()
        self.running = True

    def stop(self):
        if not self.running or not self.proc:
            return
        append_log('launcher.log', f"STOP {self.defn.key}")
        self.proc.kill()
        self.proc = None
        self.running = False

    def _capture(self, is_err: bool):
        if not self.proc:
            return
        data = self.proc.readAllStandardError() if is_err else self.proc.readAllStandardOutput()
        text = bytes(data).decode('utf-8', errors='ignore')
        for line in text.splitlines():
            append_log(f"{self.defn.key}.log", line)

    def _finished(self):
        self.running = False
        append_log('launcher.log', f"EXIT {self.defn.key}")


class LauncherWindow(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle('PixSim7 Launcher')
        self.resize(1100, 700)
        self.services = build_services()
        self.processes: Dict[str, ServiceProcess] = {s.key: ServiceProcess(s) for s in self.services}

        root = QHBoxLayout(self)
        splitter = QSplitter(Qt.Horizontal)
        root.addWidget(splitter)

        # Left panel: service list & controls
        left = QWidget(); left_layout = QVBoxLayout(left)
        splitter.addWidget(left)

        self.list = QListWidget()
        for s in self.services:
            item = QListWidgetItem(f"{s.title}")
            item.setData(Qt.UserRole, s.key)
            self.list.addItem(item)
        left_layout.addWidget(self.list)

        btn_row = QHBoxLayout()
        self.btn_start = QPushButton('Start Selected')
        self.btn_stop = QPushButton('Stop Selected')
        self.btn_open = QPushButton('Open URL')
        self.btn_all = QPushButton('Start All')
        self.btn_kill_all = QPushButton('Stop All')
        btn_row.addWidget(self.btn_start)
        btn_row.addWidget(self.btn_stop)
        btn_row.addWidget(self.btn_open)
        btn_row.addWidget(self.btn_all)
        btn_row.addWidget(self.btn_kill_all)
        left_layout.addLayout(btn_row)

        self.status_label = QLabel('Ports: backend/admin/frontend/game')
        left_layout.addWidget(self.status_label)

        # Right panel: log tail
        right = QWidget(); right_layout = QVBoxLayout(right)
        splitter.addWidget(right)
        self.log_view = QTextEdit(); self.log_view.setReadOnly(True)
        right_layout.addWidget(self.log_view)
        self.btn_refresh_logs = QPushButton('Refresh Logs')
        right_layout.addWidget(self.btn_refresh_logs)

        # Connections
        self.btn_start.clicked.connect(self.start_selected)
        self.btn_stop.clicked.connect(self.stop_selected)
        self.btn_open.clicked.connect(self.open_selected_url)
        self.btn_all.clicked.connect(self.start_all)
        self.btn_kill_all.clicked.connect(self.stop_all)
        self.btn_refresh_logs.clicked.connect(self.refresh_logs)
        self.list.currentItemChanged.connect(lambda *_: self.refresh_logs())

        self.update_ports_label()

        # Periodic tail update (every 2s)
        self.timer = QTimer(self); self.timer.timeout.connect(self.refresh_logs); self.timer.start(2000)

    def update_ports_label(self):
        p = read_env_ports()
        self.status_label.setText(f"Ports: backend={p.backend} admin={p.admin} front={p.frontend} game={p.game_frontend}")

    def selected_key(self) -> str | None:
        item = self.list.currentItem()
        return item.data(Qt.UserRole) if item else None

    def start_selected(self):
        k = self.selected_key()
        if not k:
            return
        self.processes[k].start()
        self.refresh_logs()

    def stop_selected(self):
        k = self.selected_key()
        if not k:
            return
        self.processes[k].stop()
        self.refresh_logs()

    def open_selected_url(self):
        k = self.selected_key()
        if not k:
            return
        s = next((x for x in self.services if x.key == k), None)
        if s and s.url:
            webbrowser.open(s.url)
        else:
            QMessageBox.information(self, 'No URL', 'Service has no URL')

    def start_all(self):
        for sp in self.processes.values():
            sp.start()
        self.refresh_logs()

    def stop_all(self):
        for sp in self.processes.values():
            sp.stop()
        self.refresh_logs()

    def refresh_logs(self):
        key = self.selected_key()
        if not key:
            self.log_view.setPlainText('Select a service to view logs.')
            return
        log_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 'data', 'logs', 'launcher')
        path = os.path.join(log_dir, f'{key}.log')
        if not os.path.exists(path):
            self.log_view.setPlainText('(no log yet)')
            return
        try:
            with open(path, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()[-20000:]  # tail last ~20KB
            self.log_view.setPlainText(content)
            self.log_view.moveCursor(Qt.TextCursorEnd)
        except Exception:
            self.log_view.setPlainText('(error reading log)')


def main():
    app = QApplication(sys.argv)
    w = LauncherWindow()
    w.show()
    sys.exit(app.exec())


if __name__ == '__main__':
    main()
